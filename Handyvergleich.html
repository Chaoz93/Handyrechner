<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Handyvertrag-Rechner</title>
  <style>
    :root {
      color-scheme: light dark;
      font-family: "Segoe UI", Roboto, sans-serif;
      --bg: #f4f6fb;
      --card: #ffffffcc;
      --primary: #2f59d1;
      --primary-dark: #1f3d91;
      --border: #d9dce5;
      --text-muted: #5e6471;
    }

    body {
      margin: 0;
      min-height: 100vh;
      background: linear-gradient(160deg, #e5ecff 0%, #f7f8ff 35%, #ffffff 100%);
      display: flex;
      justify-content: center;
      padding: 32px 16px 64px;
      color: #1b1f2a;
    }

    main {
      width: min(1100px, 100%);
      display: grid;
      gap: 32px;
    }

    header h1 {
      margin: 0;
      font-size: clamp(2.1rem, 1.5rem + 1.8vw, 2.8rem);
      font-weight: 700;
    }

    header p {
      margin: 8px 0 0;
      color: var(--text-muted);
      max-width: 720px;
    }

    .card {
      background: var(--card);
      backdrop-filter: blur(16px);
      border-radius: 20px;
      box-shadow: 0 24px 50px -28px rgba(47, 89, 209, 0.4);
      border: 1px solid var(--border);
      padding: 24px;
    }

    form {
      display: grid;
      gap: 16px;
    }

    .grid {
      display: grid;
      gap: 16px;
    }

    @media (min-width: 720px) {
      .grid.two {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }

      .grid.three {
        grid-template-columns: repeat(3, minmax(0, 1fr));
      }

      .grid.four {
        grid-template-columns: repeat(4, minmax(0, 1fr));
      }
    }

    label {
      display: grid;
      gap: 6px;
      font-weight: 600;
      font-size: 0.95rem;
    }

    .checkbox-label {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }

    .checkbox-label input {
      width: auto;
      margin: 0;
    }

    input, select {
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid var(--border);
      font-size: 1rem;
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
    }

    input:focus, select:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 4px rgba(47, 89, 209, 0.2);
    }

    button {
      border: none;
      border-radius: 14px;
      padding: 12px 18px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      background: var(--primary);
      color: white;
      transition: transform 0.15s ease, box-shadow 0.2s ease, background 0.2s ease;
    }

    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 14px 28px -18px var(--primary);
      background: var(--primary-dark);
    }

    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    .button-secondary {
      background: #e1e4eb;
      color: #1b1f2a;
      box-shadow: none;
      transform: none;
    }

    .button-secondary:hover {
      background: #c9ceda;
      color: #1b1f2a;
      box-shadow: none;
      transform: none;
    }

    .button-ghost {
      background: transparent;
      color: var(--primary);
      border: 1px solid rgba(47, 89, 209, 0.6);
      box-shadow: none;
    }

    .button-ghost:hover {
      background: rgba(47, 89, 209, 0.12);
      color: var(--primary-dark);
    }

    .button-danger {
      background: rgba(198, 40, 40, 0.12);
      color: #8c1d1d;
      border: 1px solid rgba(198, 40, 40, 0.35);
      box-shadow: none;
    }

    .button-danger:hover {
      background: rgba(198, 40, 40, 0.2);
      color: #6a1111;
      box-shadow: none;
    }

    .button-small {
      padding: 6px 12px;
      font-size: 0.85rem;
    }

    .form-actions {
      display: flex;
      justify-content: flex-end;
      gap: 12px;
      margin-top: 8px;
    }

    td.actions {
      text-align: right;
      white-space: nowrap;
    }

    tbody tr.editing {
      box-shadow: inset 0 0 0 2px rgba(47, 89, 209, 0.25);
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    thead th {
      text-align: left;
      color: var(--text-muted);
      font-size: 0.85rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.03em;
      padding-bottom: 10px;
    }

    tbody td {
      padding: 16px 0;
      border-top: 1px solid var(--border);
      font-size: 0.95rem;
    }

    tbody tr.highlight {
      background: rgba(47, 89, 209, 0.08);
    }

    .tag {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      border-radius: 999px;
      background: rgba(47, 89, 209, 0.12);
      color: var(--primary-dark);
      padding: 4px 10px;
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.02em;
    }

    .summary {
      display: grid;
      gap: 16px;
    }

    .summary-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 18px;
      border-radius: 16px;
      background: rgba(47, 89, 209, 0.08);
      font-weight: 600;
    }

    .table-controls {
      display: flex;
      justify-content: flex-end;
      align-items: center;
      gap: 8px;
      margin-top: 8px;
    }

    .table-controls label {
      font-weight: 600;
      font-size: 0.85rem;
      color: var(--text-muted);
    }

    .table-wrapper {
      overflow-x: auto;
    }

    td.notes {
      min-width: 220px;
    }

    .note-list {
      list-style: none;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .note-item {
      display: flex;
      align-items: flex-start;
      gap: 8px;
      font-size: 0.9rem;
      color: #1b1f2a;
    }

    .note-icon {
      font-size: 0.95rem;
      line-height: 1.4;
    }

    .note-link {
      color: var(--primary-dark);
      font-weight: 600;
      text-decoration: none;
    }

    .note-link:hover,
    .note-link:focus {
      text-decoration: underline;
    }

    .note-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 999px;
      background: rgba(47, 89, 209, 0.15);
      color: var(--primary-dark);
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.02em;
    }

    .note-text {
      line-height: 1.4;
    }

    .empty {
      padding: 32px;
      text-align: center;
      color: var(--text-muted);
    }

    .hidden {
      display: none !important;
    }

    .section-actions {
      display: flex;
      justify-content: flex-end;
      margin-bottom: 12px;
    }

    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(16, 23, 48, 0.55);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 16px;
      z-index: 50;
    }

    .modal {
      background: #fff;
      border-radius: 18px;
      width: min(520px, 100%);
      max-height: 90vh;
      overflow: hidden;
      box-shadow: 0 24px 60px -28px rgba(17, 24, 39, 0.6);
      color: #1b1f2a;
    }

    .modal header {
      padding: 20px 24px 12px;
      border-bottom: 1px solid var(--border);
    }

    .modal header h3 {
      margin: 0;
      font-size: 1.25rem;
    }

    .modal .modal-body {
      padding: 20px 24px;
      display: grid;
      gap: 16px;
    }

    .modal .modal-footer {
      padding: 16px 24px 20px;
      background: rgba(244, 246, 251, 0.8);
      display: flex;
      justify-content: flex-end;
      gap: 12px;
    }

    .modal textarea {
      min-height: 120px;
      resize: vertical;
      padding: 12px;
      border-radius: 12px;
      border: 1px solid var(--border);
      font-size: 0.95rem;
      font-family: inherit;
    }

    .modal textarea:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 4px rgba(47, 89, 209, 0.2);
    }

    .import-preview {
      border: 1px solid var(--border);
      border-radius: 12px;
      overflow: hidden;
    }

    .import-preview table {
      width: 100%;
      border-collapse: collapse;
    }

    .import-preview th,
    .import-preview td {
      padding: 10px 14px;
      border-bottom: 1px solid var(--border);
      font-size: 0.95rem;
    }

    .import-preview th {
      background: rgba(47, 89, 209, 0.08);
      text-align: left;
      font-weight: 600;
      color: var(--text-muted);
    }

    .import-preview tr:last-child td {
      border-bottom: none;
    }

    .error-message {
      color: #c62828;
      background: rgba(198, 40, 40, 0.12);
      padding: 10px 14px;
      border-radius: 12px;
      font-size: 0.9rem;
    }
  </style>
</head>
<body>
  <main>
    <header>
      <h1>Handyvertrag-Rechner</h1>
      <p>Vergleiche bequem verschiedene Handyverträge, indem du ihre Standardkosten und Laufzeiten einträgst. Die Übersicht zeigt dir die wichtigsten Kennzahlen auf einen Blick.</p>
    </header>

    <section class="card">
      <div class="section-actions">
        <button id="open-import" type="button">📥 Importieren</button>
      </div>
      <h2>Vertrag anlegen</h2>
      <form id="contract-form">
        <div class="grid two">
          <label>
            Anbieter
            <input type="text" name="provider" placeholder="z.B. Telekom" required />
          </label>
          <label>
            Tarifname
            <input type="text" name="plan" placeholder="z.B. Magenta Mobil" required />
          </label>
        </div>
        <div class="grid four">
          <label>
            Monatliche Kosten (€)
            <input type="number" name="monthly" step="0.01" min="0" required />
          </label>
          <label>
            Einmalige Kosten (€)
            <input type="number" name="upfront" step="0.01" min="0" value="0" />
          </label>
          <label>
            Laufzeit (Monate)
            <input type="number" name="duration" min="1" value="24" required />
          </label>
          <label>
            Bonuszahlungen (€)
            <input type="number" name="bonus" step="0.01" min="0" value="0" />
          </label>
        </div>
        <div>
          <label class="checkbox-label">
            <span>Anschlussgebühr (40 €)</span>
            <input type="checkbox" name="connectionFee" />
          </label>
        </div>
        <div class="grid two">
          <label>
            Datenvolumen (GB)
            <input type="number" name="data" min="0" step="0.1" placeholder="z.B. 20" />
          </label>
          <label>
            Minuten/SMS Flat
            <select name="flat">
              <option value="ja">Ja</option>
              <option value="nein">Nein</option>
            </select>
          </label>
        </div>
        <div class="grid two">
          <label>
            Handy
            <select name="device" id="device-select"></select>
          </label>
          <label>
            Direktlink
            <input type="url" name="link" placeholder="https://…" />
          </label>
        </div>
        <div id="new-device-wrapper" class="hidden">
          <label>
            Neues Handy speichern
            <input type="text" id="new-device-input" placeholder="z.B. iPhone 15" />
          </label>
        </div>
        <div>
          <label>
            Notizen
            <input type="text" name="notes" placeholder="z.B. inkl. EU-Roaming" />
          </label>
        </div>
        <div class="form-actions">
          <button type="button" class="button-secondary hidden" id="cancel-edit">Abbrechen</button>
          <button type="submit" id="submit-button">Vertrag hinzufügen</button>
        </div>
      </form>
    </section>

    <section class="card">
      <h2>Überblick</h2>
      <div id="overview">
        <p class="empty">Noch keine Verträge eingetragen.</p>
      </div>
    </section>
  </main>

  <div id="import-overlay" class="modal-overlay hidden">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="import-title">
      <header>
        <h3 id="import-title">Vertrag importieren</h3>
      </header>
      <div class="modal-body">
        <div>
          <label for="import-textarea" style="display:block; font-weight:600; margin-bottom:8px;">Importstring</label>
          <textarea id="import-textarea" placeholder="Anbieter\tTarifname\tMonatlich ..."></textarea>
        </div>
        <div style="display:flex; justify-content:flex-end;">
          <button type="button" id="import-preview">Preview anzeigen</button>
        </div>
        <p id="import-error" class="error-message hidden"></p>
        <div class="import-preview hidden" id="import-preview-wrapper">
          <table>
            <thead>
              <tr>
                <th>Feldname</th>
                <th>Wert</th>
              </tr>
            </thead>
            <tbody id="import-preview-body"></tbody>
          </table>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="button-secondary" id="import-cancel">Abbrechen</button>
        <button type="button" id="import-confirm" disabled>Import übernehmen</button>
      </div>
    </div>
  </div>

  <template id="table-template">
    <div class="grid">
      <div class="summary">
        <div class="summary-item">
          <span>Günstigste monatliche Belastung</span>
          <span id="lowest-monthly"></span>
        </div>
        <div class="summary-item">
          <span>Niedrigste Gesamtkosten</span>
          <span id="lowest-total"></span>
        </div>
        <div class="summary-item">
          <span>Durchschnittliche monatliche Kosten</span>
          <span id="average-monthly"></span>
        </div>
      </div>
      <div class="table-controls">
        <label for="sort-select">Sortieren nach</label>
        <select id="sort-select">
          <option value="effective-asc">Effektiv / Monat (aufsteigend)</option>
          <option value="effective-desc">Effektiv / Monat (absteigend)</option>
          <option value="total-asc">Gesamtkosten (aufsteigend)</option>
          <option value="total-desc">Gesamtkosten (absteigend)</option>
          <option value="monthly-asc">Monatspreis (aufsteigend)</option>
          <option value="monthly-desc">Monatspreis (absteigend)</option>
          <option value="provider-asc">Anbieter (A–Z)</option>
          <option value="provider-desc">Anbieter (Z–A)</option>
          <option value="created">Eingabereihenfolge</option>
        </select>
      </div>
      <div class="table-wrapper">
        <table>
          <thead>
            <tr>
              <th>Anbieter & Tarif</th>
              <th>Monatlich</th>
              <th>Einmalig</th>
              <th>Bonus</th>
              <th>Laufzeit</th>
              <th>Handy</th>
              <th>Gesamtkosten</th>
              <th>Effektiv / Monat</th>
              <th>Details</th>
              <th>Aktionen</th>
            </tr>
          </thead>
          <tbody id="contract-table"></tbody>
        </table>
      </div>
    </div>
  </template>

  <template id="row-template">
    <tr>
      <td>
        <div style="display:flex; flex-direction:column; gap:4px;">
          <strong class="name"></strong>
          <span class="tag data"></span>
        </div>
      </td>
      <td class="monthly"></td>
      <td class="upfront"></td>
      <td class="bonus"></td>
      <td class="duration"></td>
      <td class="device"></td>
      <td class="total"></td>
      <td class="effective"></td>
      <td class="notes"></td>
      <td class="actions">
        <div style="display:flex; gap:8px; justify-content:flex-end;">
          <button type="button" class="button-ghost button-small edit-button">Bearbeiten</button>
          <button type="button" class="button-danger button-small delete-button">Löschen</button>
        </div>
      </td>
    </tr>
  </template>

  <script>
    const form = document.getElementById('contract-form');
    const overview = document.getElementById('overview');
    const tableTemplate = document.getElementById('table-template');
    const rowTemplate = document.getElementById('row-template');
    const deviceSelect = document.getElementById('device-select');
    const newDeviceWrapper = document.getElementById('new-device-wrapper');
    const newDeviceInput = document.getElementById('new-device-input');
    const submitButton = document.getElementById('submit-button');
    const cancelEditButton = document.getElementById('cancel-edit');

    const importOpenButton = document.getElementById('open-import');
    const importOverlay = document.getElementById('import-overlay');
    const importTextarea = document.getElementById('import-textarea');
    const importPreviewButton = document.getElementById('import-preview');
    const importPreviewWrapper = document.getElementById('import-preview-wrapper');
    const importPreviewBody = document.getElementById('import-preview-body');
    const importError = document.getElementById('import-error');
    const importCancel = document.getElementById('import-cancel');
    const importConfirm = document.getElementById('import-confirm');

    const importFields = [
      { key: 'anbieter', label: 'Anbieter' },
      { key: 'tarif', label: 'Tarifname' },
      { key: 'monatlich', label: 'Monatlich (€)' },
      { key: 'einmalig', label: 'Einmalig (€)' },
      { key: 'laufzeit', label: 'Laufzeit (Monate)' },
      { key: 'bonus', label: 'Bonus (€)' },
      { key: 'anschluss', label: 'Anschlussgebühr (€)' },
      { key: 'datenvolumen', label: 'Datenvolumen (GB)' },
      { key: 'flat', label: 'Minuten/SMS Flat' },
      { key: 'handy', label: 'Handy' },
      { key: 'link', label: 'Direktlink' },
      { key: 'notizen', label: 'Notizen' },
    ];

    let parsedImport = null;

    function resetImportModal() {
      importTextarea.value = '';
      importError.textContent = '';
      importError.classList.add('hidden');
      importPreviewWrapper.classList.add('hidden');
      importPreviewBody.innerHTML = '';
      importConfirm.disabled = true;
      parsedImport = null;
    }

    function openImportModal() {
      resetImportModal();
      importOverlay.classList.remove('hidden');
      setTimeout(() => {
        importTextarea.focus();
      }, 0);
    }

    function closeImportModal() {
      importOverlay.classList.add('hidden');
      resetImportModal();
    }

    function parseImportString(raw) {
      const trimmed = (raw || '').trim();
      if (!trimmed) {
        throw new Error('Bitte gib einen Importstring ein.');
      }

      const line = trimmed.split(/\r?\n/).find(entry => entry.trim().length > 0);
      if (!line) {
        throw new Error('Der Importstring ist leer.');
      }

      const values = line.split('\t');
      if (values.length !== importFields.length) {
        throw new Error(`Der Importstring muss genau ${importFields.length} Werte enthalten.`);
      }

      const [
        anbieter,
        tarif,
        monatlich,
        einmalig,
        laufzeit,
        bonus,
        anschluss,
        datenvolumen,
        flat,
        handy,
        link,
        notizen,
      ] = values.map(value => value.trim());

      return {
        anbieter,
        tarif,
        monatlich,
        einmalig,
        laufzeit,
        bonus,
        anschluss,
        datenvolumen,
        flat,
        handy,
        link,
        notizen,
      };
    }

    function renderImportPreview(data) {
      importPreviewBody.innerHTML = '';
      importFields.forEach(field => {
        const row = document.createElement('tr');
        const labelCell = document.createElement('td');
        labelCell.textContent = field.label;
        const valueCell = document.createElement('td');
        valueCell.textContent = data[field.key] || '—';
        row.append(labelCell, valueCell);
        importPreviewBody.appendChild(row);
      });
      importPreviewWrapper.classList.remove('hidden');
    }

    function toNumberString(value) {
      const str = (value || '').toString().trim();
      if (!str) {
        return '';
      }
      return str.replace(',', '.');
    }

    function applyImportToForm(data) {
      resetFormState();
      render();

      form.elements['provider'].value = data.anbieter || '';
      form.elements['plan'].value = data.tarif || '';
      form.elements['monthly'].value = toNumberString(data.monatlich);
      form.elements['upfront'].value = toNumberString(data.einmalig);
      form.elements['duration'].value = toNumberString(data.laufzeit);
      form.elements['bonus'].value = toNumberString(data.bonus);

      const connectionValue = Number(toNumberString(data.anschluss)) || 0;
      form.elements['connectionFee'].checked = connectionValue > 0;

      form.elements['data'].value = toNumberString(data.datenvolumen);

      const flatValue = (data.flat || '').toString().trim().toLowerCase();
      form.elements['flat'].value = flatValue === 'ja' ? 'ja' : 'nein';

      const deviceValue = (data.handy || '').trim();
      if (deviceValue) {
        if (!devices.includes(deviceValue)) {
          devices.push(deviceValue);
          devices.sort((a, b) => a.localeCompare(b, 'de', { sensitivity: 'base' }));
          saveDevices();
        }
        populateDeviceOptions(deviceValue);
        deviceSelect.value = deviceValue;
      } else {
        populateDeviceOptions('');
      }

      showNewDeviceInput(false);
      newDeviceInput.value = '';

      form.elements['link'].value = data.link || '';
      form.elements['notes'].value = data.notizen || '';
    }

    importOpenButton.addEventListener('click', () => {
      openImportModal();
    });

    importCancel.addEventListener('click', () => {
      closeImportModal();
    });

    importOverlay.addEventListener('click', event => {
      if (event.target === importOverlay) {
        closeImportModal();
      }
    });

    document.addEventListener('keydown', event => {
      if (event.key === 'Escape' && !importOverlay.classList.contains('hidden')) {
        closeImportModal();
      }
    });

    importPreviewButton.addEventListener('click', () => {
      try {
        const parsed = parseImportString(importTextarea.value);
        parsedImport = parsed;
        renderImportPreview(parsed);
        importError.classList.add('hidden');
        importError.textContent = '';
        importConfirm.disabled = false;
      } catch (error) {
        parsedImport = null;
        importPreviewWrapper.classList.add('hidden');
        importPreviewBody.innerHTML = '';
        importError.textContent = error.message;
        importError.classList.remove('hidden');
        importConfirm.disabled = true;
      }
    });

    importConfirm.addEventListener('click', () => {
      if (!parsedImport) {
        return;
      }
      applyImportToForm(parsedImport);
      closeImportModal();
    });

    importTextarea.addEventListener('input', () => {
      parsedImport = null;
      importConfirm.disabled = true;
      importPreviewWrapper.classList.add('hidden');
      importPreviewBody.innerHTML = '';
      importError.classList.add('hidden');
      importError.textContent = '';
    });

    const STORAGE_KEY = 'handyvertrag-contracts';
    const SORT_STORAGE_KEY = 'handyrechner-sort';
    const SORT_DEFAULT = 'effective-asc';
    const VALID_SORTS = new Set([
      'effective-asc',
      'effective-desc',
      'total-asc',
      'total-desc',
      'monthly-asc',
      'monthly-desc',
      'provider-asc',
      'provider-desc',
      'created',
    ]);

    function loadContracts() {
      try {
        const stored = localStorage.getItem(STORAGE_KEY);
        const parsed = stored ? JSON.parse(stored) : [];
        return Array.isArray(parsed) ? parsed : [];
      } catch (error) {
        console.warn('Konnte gespeicherte Verträge nicht laden:', error);
        return [];
      }
    }

    function saveContracts() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(contracts));
    }

    function loadSortPreference() {
      try {
        const stored = localStorage.getItem(SORT_STORAGE_KEY);
        return stored && VALID_SORTS.has(stored) ? stored : SORT_DEFAULT;
      } catch (error) {
        console.warn('Sortierung konnte nicht geladen werden.', error);
        return SORT_DEFAULT;
      }
    }

    function saveSortPreference(sort) {
      try {
        localStorage.setItem(SORT_STORAGE_KEY, sort);
      } catch (error) {
        console.warn('Sortierung konnte nicht gespeichert werden.', error);
      }
    }

    function updateContractCalculations(contract) {
      const monthly = Number(contract.monthly) || 0;
      const upfront = Number(contract.upfront) || 0;
      const duration = Number(contract.duration) || 0;
      const bonus = Number(contract.bonus) || 0;
      const connectionFeeAmount = Number(contract.connectionFeeAmount) || 0;

      const total = monthly * duration + upfront + connectionFeeAmount - bonus;

      contract.monthly = monthly;
      contract.upfront = upfront;
      contract.duration = duration;
      contract.bonus = bonus;
      contract.connectionFeeAmount = connectionFeeAmount;
      contract.total = total;
      contract.effective = duration ? total / duration : 0;
    }

    function sortContractEntries(entries, sortKey) {
      if (!VALID_SORTS.has(sortKey) || sortKey === 'created') {
        return entries;
      }

      const sorted = [...entries];
      const comparator = getSortComparator(sortKey);
      if (comparator) {
        sorted.sort(comparator);
      }
      return sorted;
    }

    function getSortComparator(sortKey) {
      switch (sortKey) {
        case 'effective-asc':
          return (a, b) => a.contract.effective - b.contract.effective || a.index - b.index;
        case 'effective-desc':
          return (a, b) => b.contract.effective - a.contract.effective || a.index - b.index;
        case 'total-asc':
          return (a, b) => a.contract.total - b.contract.total || a.index - b.index;
        case 'total-desc':
          return (a, b) => b.contract.total - a.contract.total || a.index - b.index;
        case 'monthly-asc':
          return (a, b) => a.contract.monthly - b.contract.monthly || a.index - b.index;
        case 'monthly-desc':
          return (a, b) => b.contract.monthly - a.contract.monthly || a.index - b.index;
        case 'provider-asc':
          return (a, b) => {
            const providerA = (a.contract.provider || '').toString();
            const providerB = (b.contract.provider || '').toString();
            const planA = (a.contract.plan || '').toString();
            const planB = (b.contract.plan || '').toString();
            return (
              providerA.localeCompare(providerB, 'de', { sensitivity: 'base' }) ||
              planA.localeCompare(planB, 'de', { sensitivity: 'base' }) ||
              a.index - b.index
            );
          };
        case 'provider-desc':
          return (a, b) => {
            const providerA = (a.contract.provider || '').toString();
            const providerB = (b.contract.provider || '').toString();
            const planA = (a.contract.plan || '').toString();
            const planB = (b.contract.plan || '').toString();
            return (
              providerB.localeCompare(providerA, 'de', { sensitivity: 'base' }) ||
              planB.localeCompare(planA, 'de', { sensitivity: 'base' }) ||
              a.index - b.index
            );
          };
        default:
          return null;
      }
    }

    function createNoteItem(icon, contentNode) {
      const item = document.createElement('li');
      item.className = 'note-item';

      const iconEl = document.createElement('span');
      iconEl.className = 'note-icon';
      iconEl.textContent = icon;
      item.appendChild(iconEl);

      if (typeof contentNode === 'string') {
        item.appendChild(document.createTextNode(contentNode));
      } else if (contentNode instanceof Node) {
        item.appendChild(contentNode);
      }

      return item;
    }

    function buildNotesCell(cell, contract) {
      cell.innerHTML = '';
      const noteItems = [];

      if (contract.link) {
        const linkEl = document.createElement('a');
        linkEl.href = contract.link;
        linkEl.target = '_blank';
        linkEl.rel = 'noopener';
        linkEl.textContent = 'Direktlink öffnen';
        linkEl.className = 'note-link';
        noteItems.push(createNoteItem('🔗', linkEl));
      }

      if (contract.connectionFeeAmount) {
        const badge = document.createElement('span');
        badge.className = 'note-badge';
        badge.textContent = 'Anschlussgebühr enthalten';
        noteItems.push(createNoteItem('💶', badge));
      }

      if (contract.notes) {
        const text = document.createElement('span');
        text.className = 'note-text';
        text.textContent = contract.notes;
        noteItems.push(createNoteItem('📝', text));
      }

      if (!noteItems.length) {
        cell.textContent = '—';
        return;
      }

      const list = document.createElement('ul');
      list.className = 'note-list';
      noteItems.forEach(item => list.appendChild(item));
      cell.appendChild(list);
    }

    const contracts = loadContracts();
    contracts.forEach(updateContractCalculations);
    let currentSort = loadSortPreference();

    const deviceStorageKey = 'handyrechner-devices';
    let devices = [];

    try {
      const storedDevices = localStorage.getItem(deviceStorageKey);
      if (storedDevices) {
        const parsed = JSON.parse(storedDevices);
        if (Array.isArray(parsed)) {
          devices = parsed
            .map(device => (typeof device === 'string' ? device.trim() : ''))
            .filter(device => device);
        }
      }
    } catch (error) {
      console.warn('Gespeicherte Geräte konnten nicht geladen werden.', error);
    }

    function saveDevices() {
      try {
        localStorage.setItem(deviceStorageKey, JSON.stringify(devices));
      } catch (error) {
        console.warn('Geräteliste konnte nicht gespeichert werden.', error);
      }
    }

    function populateDeviceOptions(selected = '') {
      deviceSelect.innerHTML = '';

      const placeholder = document.createElement('option');
      placeholder.value = '';
      placeholder.textContent = 'Handy wählen (optional)';
      deviceSelect.appendChild(placeholder);

      devices.forEach(device => {
        const option = document.createElement('option');
        option.value = device;
        option.textContent = device;
        deviceSelect.appendChild(option);
      });

      const createOption = document.createElement('option');
      createOption.value = '__new__';
      createOption.textContent = 'Neues Handy hinzufügen…';
      deviceSelect.appendChild(createOption);

      const availableOption = Array.from(deviceSelect.options).find(
        option => option.value === selected
      );

      deviceSelect.value = availableOption ? selected : '';
    }

    function showNewDeviceInput(show) {
      if (show) {
        newDeviceWrapper.classList.remove('hidden');
        newDeviceInput.focus();
      } else {
        newDeviceWrapper.classList.add('hidden');
        newDeviceInput.value = '';
      }
    }

    deviceSelect.addEventListener('change', () => {
      showNewDeviceInput(deviceSelect.value === '__new__');
    });

    const euro = new Intl.NumberFormat('de-DE', {
      style: 'currency',
      currency: 'EUR',
    });

    let editingIndex = null;

    function render() {
      overview.innerHTML = '';

      if (!contracts.length) {
        overview.innerHTML = '<p class="empty">Noch keine Verträge eingetragen.</p>';
        return;
      }

      if (!VALID_SORTS.has(currentSort)) {
        currentSort = SORT_DEFAULT;
      }

      const contractEntries = contracts.map((contract, index) => {
        updateContractCalculations(contract);
        return { contract, index };
      });

      const sortedEntries = sortContractEntries(contractEntries, currentSort);

      const fragment = tableTemplate.content.cloneNode(true);
      const tbody = fragment.getElementById('contract-table');
      const sortSelect = fragment.getElementById('sort-select');

      if (sortSelect) {
        sortSelect.value = currentSort;
        sortSelect.addEventListener('change', event => {
          const nextSort = event.target.value;
          currentSort = VALID_SORTS.has(nextSort) ? nextSort : SORT_DEFAULT;
          saveSortPreference(currentSort);
          render();
        });
      }

      let lowestMonthly = { value: Infinity, row: null };
      let lowestTotal = { value: Infinity, row: null };
      let monthlySum = 0;

      sortedEntries.forEach(({ contract, index }) => {
        const row = rowTemplate.content.cloneNode(true);
        const tr = row.querySelector('tr');

        if (index === editingIndex) {
          tr.classList.add('editing');
        }

        const name = row.querySelector('.name');
        name.textContent = `${contract.provider} – ${contract.plan}`;

        const dataTag = row.querySelector('.data');
        const dataText = contract.data ? `${contract.data} GB` : 'Datenvolumen n. a.';
        dataTag.textContent = `${dataText}${contract.flat === 'ja' ? ' · Allnet-Flat' : ''}`;

        row.querySelector('.monthly').textContent = euro.format(contract.monthly);
        const bonusValue = Number(contract.bonus) || 0;
        row.querySelector('.bonus').textContent = bonusValue
          ? `− ${euro.format(bonusValue)}`
          : '—';
        const upfrontSum = (contract.upfront || 0) + (contract.connectionFeeAmount || 0);
        row.querySelector('.upfront').textContent = euro.format(upfrontSum);

        row.querySelector('.duration').textContent = `${contract.duration} Monate`;
        row.querySelector('.total').textContent = euro.format(contract.total);
        row.querySelector('.effective').textContent = euro.format(contract.effective);
        row.querySelector('.device').textContent = contract.device || '—';

        const notesCell = row.querySelector('.notes');
        buildNotesCell(notesCell, contract);

        const editButton = row.querySelector('.edit-button');
        if (editButton) {
          editButton.addEventListener('click', () => startEdit(index));
        }

        const deleteButton = row.querySelector('.delete-button');
        if (deleteButton) {
          deleteButton.addEventListener('click', () => deleteContract(index));
        }

        tbody.appendChild(row);

        monthlySum += contract.effective;

        if (contract.effective < lowestMonthly.value) {
          lowestMonthly = { value: contract.effective, row: tr };
        }

        if (contract.total < lowestTotal.value) {
          lowestTotal = { value: contract.total, row: tr };
        }
      });

      const lowestMonthlyEl = fragment.getElementById('lowest-monthly');
      const lowestTotalEl = fragment.getElementById('lowest-total');
      const avgMonthlyEl = fragment.getElementById('average-monthly');

      lowestMonthlyEl.textContent = euro.format(lowestMonthly.value);
      lowestTotalEl.textContent = euro.format(lowestTotal.value);
      avgMonthlyEl.textContent = euro.format(monthlySum / contracts.length);

      if (lowestMonthly.row) {
        lowestMonthly.row.classList.add('highlight');
      }

      if (lowestTotal.row) {
        lowestTotal.row.classList.add('highlight');
      }

      overview.appendChild(fragment);
    }

    function resetFormState(selectedDevice = '') {
      form.reset();
      editingIndex = null;
      submitButton.textContent = 'Vertrag hinzufügen';
      cancelEditButton.classList.add('hidden');
      populateDeviceOptions(selectedDevice);
      showNewDeviceInput(false);
      newDeviceInput.value = '';
    }

    function fillFormWithContract(contract) {
      form.elements['provider'].value = contract.provider || '';
      form.elements['plan'].value = contract.plan || '';
      form.elements['monthly'].value = contract.monthly ?? '';
      form.elements['upfront'].value = contract.upfront ?? '';
      form.elements['duration'].value = contract.duration ?? '';
      form.elements['bonus'].value = contract.bonus ?? '';
      form.elements['connectionFee'].checked = (contract.connectionFeeAmount || 0) > 0;
      form.elements['data'].value = contract.data ?? '';
      form.elements['flat'].value = contract.flat === 'nein' ? 'nein' : 'ja';
      form.elements['device'].value = contract.device || '';
      form.elements['link'].value = contract.link || '';
      form.elements['notes'].value = contract.notes || '';
      showNewDeviceInput(false);
      newDeviceInput.value = '';
    }

    function startEdit(index) {
      const contract = contracts[index];
      if (!contract) {
        return;
      }

      editingIndex = index;

      if (contract.device && !devices.includes(contract.device)) {
        devices.push(contract.device);
        devices.sort((a, b) => a.localeCompare(b, 'de', { sensitivity: 'base' }));
        saveDevices();
      }

      populateDeviceOptions(contract.device || '');
      fillFormWithContract(contract);
      submitButton.textContent = 'Vertrag aktualisieren';
      cancelEditButton.classList.remove('hidden');
      form.scrollIntoView({ behavior: 'smooth', block: 'start' });
      render();
    }

    function deleteContract(index) {
      const contract = contracts[index];
      if (!contract) {
        return;
      }

      const provider = contract.provider || 'Unbekannter Anbieter';
      const plan = contract.plan || 'Unbekannter Tarif';
      const message = `Soll der Tarif "${provider} – ${plan}" wirklich gelöscht werden?`;

      if (!window.confirm(message)) {
        return;
      }

      contracts.splice(index, 1);

      if (editingIndex !== null) {
        if (editingIndex === index) {
          resetFormState();
        } else if (editingIndex > index) {
          editingIndex -= 1;
        }
      }

      saveContracts();
      render();
    }

    cancelEditButton.addEventListener('click', () => {
      resetFormState();
      render();
    });

    form.addEventListener('submit', event => {
      event.preventDefault();
      const formData = new FormData(form);

      const monthly = Number(formData.get('monthly')) || 0;
      const upfront = Number(formData.get('upfront')) || 0;
      const duration = Number(formData.get('duration')) || 0;
      const bonus = Number(formData.get('bonus')) || 0;
      const connectionFeeAmount = formData.get('connectionFee') ? 40 : 0;

      let device = formData.get('device') || '';
      const link = (formData.get('link') || '').trim();

      if (device === '__new__') {
        const newDevice = newDeviceInput.value.trim();
        if (newDevice) {
          if (!devices.includes(newDevice)) {
            devices.push(newDevice);
            devices.sort((a, b) => a.localeCompare(b, 'de', { sensitivity: 'base' }));
            saveDevices();
          }
          device = newDevice;
          populateDeviceOptions(device);
        } else {
          device = '';
        }
      }

      const newContract = {
        provider: (formData.get('provider') || '').trim(),
        plan: (formData.get('plan') || '').trim(),
        monthly,
        upfront,
        duration,
        bonus,
        data: formData.get('data'),
        flat: formData.get('flat'),
        device,
        link,
        notes: (formData.get('notes') || '').trim(),
        connectionFeeAmount,
      };

      updateContractCalculations(newContract);
      const isEdit = editingIndex !== null;

      if (isEdit) {
        contracts[editingIndex] = { ...contracts[editingIndex], ...newContract };
      } else {
        contracts.push(newContract);
      }

      saveContracts();

      const keepDeviceSelection = isEdit ? '' : newContract.device || '';
      resetFormState(keepDeviceSelection);

      render();
    });

    resetFormState();
    render();
  </script>
</body>
</html>
