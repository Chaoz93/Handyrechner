<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Handyvertrag-Rechner</title>
  <style>
    :root {
      color-scheme: light dark;
      font-family: "Segoe UI", Roboto, sans-serif;
      --bg: #f4f6fb;
      --card: #ffffffcc;
      --primary: #2f59d1;
      --primary-dark: #1f3d91;
      --border: #d9dce5;
      --text-muted: #5e6471;
    }

    body {
      margin: 0;
      min-height: 100vh;
      background: linear-gradient(160deg, #e5ecff 0%, #f7f8ff 35%, #ffffff 100%);
      display: flex;
      justify-content: center;
      padding: 32px 16px 64px;
      color: #1b1f2a;
    }

    main {
      width: min(2100px, 100%);
      display: grid;
      gap: 32px;
    }

    header h1 {
      margin: 0;
      font-size: clamp(2.1rem, 1.5rem + 1.8vw, 2.8rem);
      font-weight: 700;
    }

    header p {
      margin: 8px 0 0;
      color: var(--text-muted);
      max-width: 720px;
    }

    .card {
      background: var(--card);
      backdrop-filter: blur(16px);
      border-radius: 20px;
      box-shadow: 0 24px 50px -28px rgba(47, 89, 209, 0.4);
      border: 1px solid var(--border);
      padding: 24px;
    }

    form {
      display: grid;
      gap: 16px;
    }

    .grid {
      display: grid;
      gap: 16px;
    }

    @media (min-width: 720px) {
      .grid.two {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }

      .grid.three {
        grid-template-columns: repeat(3, minmax(0, 1fr));
      }

      .grid.four {
        grid-template-columns: repeat(4, minmax(0, 1fr));
      }
    }

    label {
      display: grid;
      gap: 6px;
      font-weight: 600;
      font-size: 0.95rem;
    }

    .checkbox-label {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }

    .checkbox-label input {
      width: auto;
      margin: 0;
    }

    input, select {
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid var(--border);
      font-size: 1rem;
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
    }

    input:focus, select:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 4px rgba(47, 89, 209, 0.2);
    }

    button {
      border: none;
      border-radius: 14px;
      padding: 12px 18px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      background: var(--primary);
      color: white;
      transition: transform 0.15s ease, box-shadow 0.2s ease, background 0.2s ease;
    }

    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 14px 28px -18px var(--primary);
      background: var(--primary-dark);
    }

    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    .button-secondary {
      background: #e1e4eb;
      color: #1b1f2a;
      box-shadow: none;
      transform: none;
    }

    .button-secondary:hover {
      background: #c9ceda;
      color: #1b1f2a;
      box-shadow: none;
      transform: none;
    }

    .button-ghost {
      background: transparent;
      color: var(--primary);
      border: 1px solid rgba(47, 89, 209, 0.6);
      box-shadow: none;
    }

    .button-ghost:hover {
      background: rgba(47, 89, 209, 0.12);
      color: var(--primary-dark);
    }

    .button-danger {
      background: rgba(198, 40, 40, 0.12);
      color: #8c1d1d;
      border: 1px solid rgba(198, 40, 40, 0.35);
      box-shadow: none;
    }

    .button-danger:hover {
      background: rgba(198, 40, 40, 0.2);
      color: #6a1111;
      box-shadow: none;
    }

    .button-small {
      padding: 6px 12px;
      font-size: 0.85rem;
    }

    .form-actions {
      display: flex;
      justify-content: flex-end;
      gap: 12px;
      margin-top: 8px;
    }

    .table-row.editing {
      box-shadow: inset 0 0 0 2px rgba(47, 89, 209, 0.25);
    }

    .tag {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      border-radius: 999px;
      background: rgba(47, 89, 209, 0.12);
      color: var(--primary-dark);
      padding: 4px 10px;
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.02em;
    }

    .summary {
      display: grid;
      gap: 16px;
    }

    .summary-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 18px;
      border-radius: 16px;
      background: rgba(47, 89, 209, 0.08);
      font-weight: 600;
    }

    .table-controls {
      display: flex;
      justify-content: flex-end;
      align-items: center;
      gap: 8px;
      margin-top: 8px;
    }

    .table-controls label {
      font-weight: 600;
      font-size: 0.85rem;
      color: var(--text-muted);
    }

    .table-wrapper {
      overflow-x: auto;
      padding: 12px 16px;
      border-radius: 18px;
      background: rgba(255, 255, 255, 0.55);
    }

    .comparison-table {
      display: flex;
      flex-direction: column;
      width: 100%;
      gap: 0;
    }

    .table-row {
      display: grid;
      grid-template-columns:
        minmax(240px, 2.2fr)
        minmax(200px, 1.7fr)
        repeat(4, minmax(80px, 0.85fr))
        minmax(150px, 1.1fr)
        minmax(160px, 1.1fr)
        minmax(72px, 0.7fr)
        minmax(140px, 0.95fr);
      grid-template-areas:
        'provider device monthly upfront bonus duration total effective details actions';
      column-gap: 16px;
      align-items: stretch;
    }

    .table-row.table-header {
      padding-bottom: 12px;
      border-bottom: 1px solid var(--border);
    }

    .table-row.table-header .cell {
      font-size: 0.78rem;
      font-weight: 700;
      letter-spacing: 0.04em;
      text-transform: uppercase;
      color: var(--text-muted);
      justify-content: flex-start;
    }

    .table-body {
      display: flex;
      flex-direction: column;
      width: 100%;
    }

    .table-body .table-row {
      padding: 16px 0;
      border-bottom: 1px solid var(--border);
      cursor: pointer;
      transition: background 0.2s ease, box-shadow 0.2s ease;
    }

    .table-body .table-row:last-child {
      border-bottom: none;
    }

    .table-row.selectable:hover {
      background: rgba(47, 89, 209, 0.06);
    }

    .table-row.highlight:not(.selected) {
      background: rgba(47, 89, 209, 0.08);
    }

    .table-row.selected {
      outline: 2px solid var(--primary);
      outline-offset: -2px;
      background: rgba(47, 89, 209, 0.12);
    }

    .cell {
      display: flex;
      align-items: center;
      padding: 0 8px;
      min-height: 44px;
      font-size: 0.95rem;
      line-height: 1.4;
    }

    .cell--provider {
      grid-area: provider;
    }

    .cell--device {
      grid-area: device;
    }

    .cell--monthly,
    .cell--upfront,
    .cell--bonus,
    .cell--duration {
      justify-content: center;
      text-align: center;
      white-space: nowrap;
    }

    .cell--monthly {
      grid-area: monthly;
    }

    .cell--upfront {
      grid-area: upfront;
    }

    .cell--bonus {
      grid-area: bonus;
    }

    .cell--duration {
      grid-area: duration;
    }

    .cell--total {
      grid-area: total;
      justify-content: center;
      text-align: center;
      font-weight: 700;
      font-size: 1.1rem;
      color: var(--primary-dark);
    }

    .cell--effective {
      grid-area: effective;
      justify-content: center;
      text-align: center;
      font-weight: 700;
      font-size: 1.1rem;
      color: var(--primary-dark);
    }

    .cell--details {
      grid-area: details;
      justify-content: center;
    }

    .cell--actions {
      grid-area: actions;
      justify-content: flex-end;
      gap: 8px;
    }

    .provider-stack {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .provider-stack .name {
      font-weight: 700;
      font-size: 1rem;
    }

    .actions-group {
      display: inline-flex;
      gap: 8px;
    }

    .details-button {
      width: 36px;
      height: 36px;
      border-radius: 999px;
      border: none;
      background: rgba(47, 89, 209, 0.12);
      color: var(--primary-dark);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 1.1rem;
      cursor: pointer;
      transition: background 0.2s ease, transform 0.2s ease, box-shadow 0.2s ease;
      position: relative;
    }

    .details-button:hover,
    .details-button:focus-visible {
      background: rgba(47, 89, 209, 0.22);
      transform: translateY(-1px);
      box-shadow: 0 12px 24px -16px rgba(47, 89, 209, 0.55);
      outline: none;
    }

    .details-button:disabled {
      background: rgba(17, 24, 39, 0.08);
      color: var(--text-muted);
      cursor: not-allowed;
      box-shadow: none;
      transform: none;
    }

    .details-button[data-tooltip]:hover::before,
    .details-button[data-tooltip]:focus-visible::before {
      content: '';
      position: absolute;
      top: calc(100% + 6px);
      right: 14px;
      width: 10px;
      height: 10px;
      background: #111827;
      transform: rotate(45deg);
      box-shadow: 0 12px 24px -16px rgba(17, 24, 39, 0.65);
      pointer-events: none;
      z-index: 9;
    }

    .details-button[data-tooltip]:hover::after,
    .details-button[data-tooltip]:focus-visible::after {
      content: attr(data-tooltip);
      position: absolute;
      top: calc(100% + 10px);
      right: -4px;
      background: #111827;
      color: #fff;
      padding: 10px 14px;
      border-radius: 12px;
      font-size: 0.75rem;
      line-height: 1.35;
      white-space: pre-line;
      min-width: 200px;
      box-shadow: 0 18px 32px -20px rgba(17, 24, 39, 0.65);
      pointer-events: none;
      z-index: 9;
    }

    @media (max-width: 1280px) {
      .table-row {
        grid-template-columns:
          minmax(220px, 2fr)
          minmax(180px, 1.5fr)
          repeat(4, minmax(72px, 0.8fr))
          minmax(140px, 1.05fr)
          minmax(150px, 1.05fr)
          minmax(64px, 0.65fr)
          minmax(120px, 0.85fr);
      }
    }

    @media (max-width: 960px) {
      .table-wrapper {
        padding: 0;
        background: transparent;
      }

      .comparison-table {
        gap: 16px;
      }

      .table-row.table-header {
        display: none;
      }

      .table-body {
        gap: 16px;
      }

      .table-body .table-row {
        border: 1px solid var(--border);
        border-radius: 18px;
        padding: 18px 16px;
        grid-template-columns: repeat(2, minmax(0, 1fr));
        grid-template-areas:
          'provider provider'
          'device device'
          'monthly upfront'
          'total total'
          'effective effective'
          'bonus duration'
          'details actions';
        row-gap: 16px;
        background: rgba(255, 255, 255, 0.55);
      }

      .table-row.selectable:hover {
        background: rgba(47, 89, 209, 0.08);
      }

      .table-row.selected {
        outline-offset: 0;
      }

      .cell {
        padding: 0;
        align-items: flex-start;
      }

      .cell::before {
        content: attr(data-label);
        display: block;
        font-size: 0.72rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.04em;
        color: var(--text-muted);
        margin-bottom: 4px;
      }

      .cell--provider::before,
      .cell--device::before {
        display: none;
      }

      .cell--total,
      .cell--effective {
        justify-content: flex-start;
        text-align: left;
        font-size: 1.2rem;
      }

      .cell--monthly,
      .cell--upfront,
      .cell--bonus,
      .cell--duration {
        justify-content: flex-start;
        text-align: left;
      }

      .cell--details,
      .cell--actions {
        justify-content: flex-start;
      }

      .details-button[data-tooltip]:hover::before,
      .details-button[data-tooltip]:focus-visible::before {
        right: auto;
        left: 16px;
      }

      .details-button[data-tooltip]:hover::after,
      .details-button[data-tooltip]:focus-visible::after {
        right: auto;
        left: 0;
      }
    }

    .empty {
      padding: 32px;
      text-align: center;
      color: var(--text-muted);
    }

    .hidden {
      display: none !important;
    }

    .selected-contract {
      display: grid;
      gap: 16px;
      padding: 20px;
      border-radius: 18px;
      border: 1px solid rgba(47, 89, 209, 0.25);
      background: rgba(47, 89, 209, 0.1);
    }

    .selected-contract-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 16px;
      flex-wrap: wrap;
    }

    .selected-contract-header h3 {
      margin: 0 0 4px;
      font-size: 1.25rem;
    }

    .selected-contract-header p {
      margin: 0;
      color: var(--text-muted);
      font-size: 0.95rem;
    }

    .selected-contract-actions {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    .selected-contract-grid {
      display: grid;
      gap: 16px;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
    }

    .selected-field {
      display: grid;
      gap: 4px;
    }

    .selected-label {
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      color: var(--text-muted);
    }

    .selected-value {
      font-size: 1.1rem;
      font-weight: 600;
    }

    .selected-notes {
      margin: 0;
      font-size: 0.9rem;
      color: #1b1f2a;
    }

    .selected-link {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-weight: 600;
      color: var(--primary);
      text-decoration: none;
    }

    .selected-link::after {
      content: '‚Üó';
      font-size: 0.85rem;
    }

    .selected-link:hover,
    .selected-link:focus {
      text-decoration: underline;
    }

    .section-actions {
      display: flex;
      justify-content: flex-end;
      margin-bottom: 12px;
    }

    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(16, 23, 48, 0.55);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 16px;
      z-index: 50;
    }

    .modal {
      background: #fff;
      border-radius: 18px;
      width: min(520px, 100%);
      max-height: 90vh;
      overflow: hidden;
      box-shadow: 0 24px 60px -28px rgba(17, 24, 39, 0.6);
      color: #1b1f2a;
    }

    .modal header {
      padding: 20px 24px 12px;
      border-bottom: 1px solid var(--border);
    }

    .modal header h3 {
      margin: 0;
      font-size: 1.25rem;
    }

    .modal .modal-body {
      padding: 20px 24px;
      display: grid;
      gap: 16px;
    }

    .modal .modal-footer {
      padding: 16px 24px 20px;
      background: rgba(244, 246, 251, 0.8);
      display: flex;
      justify-content: flex-end;
      gap: 12px;
    }

    .modal textarea {
      min-height: 120px;
      resize: vertical;
      padding: 12px;
      border-radius: 12px;
      border: 1px solid var(--border);
      font-size: 0.95rem;
      font-family: inherit;
    }

    .modal textarea:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 4px rgba(47, 89, 209, 0.2);
    }

    .import-preview {
      border: 1px solid var(--border);
      border-radius: 12px;
      overflow: hidden;
    }

    .import-preview table {
      width: 100%;
      border-collapse: collapse;
    }

    .import-preview th,
    .import-preview td {
      padding: 10px 14px;
      border-bottom: 1px solid var(--border);
      font-size: 0.95rem;
    }

    .import-preview th {
      background: rgba(47, 89, 209, 0.08);
      text-align: left;
      font-weight: 600;
      color: var(--text-muted);
    }

    .import-preview tr:last-child td {
      border-bottom: none;
    }

    .import-preview .entry-header td {
      background: rgba(47, 89, 209, 0.12);
      font-weight: 600;
      color: var(--primary);
    }

    .error-message {
      color: #c62828;
      background: rgba(198, 40, 40, 0.12);
      padding: 10px 14px;
      border-radius: 12px;
      font-size: 0.9rem;
    }
  </style>
</head>
<body>
  <main>
    <header>
      <h1>Handyvertrag-Rechner</h1>
      <p>Vergleiche bequem verschiedene Handyvertr√§ge, indem du ihre Standardkosten und Laufzeiten eintr√§gst. Die √úbersicht zeigt dir die wichtigsten Kennzahlen auf einen Blick.</p>
    </header>

    <section class="card">
      <div class="section-actions">
        <button id="export-contracts" type="button" class="button-secondary">üì§ Exportieren</button>
        <button id="open-import" type="button">üì• Importieren</button>
      </div>
      <h2>Vertrag anlegen</h2>
      <form id="contract-form">
        <div class="grid two">
          <label>
            Anbieter
            <input type="text" name="provider" placeholder="z.B. Telekom" required />
          </label>
          <label>
            Tarifname
            <input type="text" name="plan" placeholder="z.B. Magenta Mobil" required />
          </label>
        </div>
        <div class="grid four">
          <label>
            Monatliche Kosten (‚Ç¨)
            <input type="number" name="monthly" step="0.01" min="0" required />
          </label>
          <label>
            Einmalige Kosten (‚Ç¨)
            <input type="number" name="upfront" step="0.01" min="0" value="0" />
          </label>
          <label>
            Laufzeit (Monate)
            <input type="number" name="duration" min="1" value="24" required />
          </label>
          <label>
            Bonuszahlungen (‚Ç¨)
            <input type="number" name="bonus" step="0.01" min="0" value="0" />
          </label>
        </div>
        <div>
          <label class="checkbox-label">
            <span>Anschlussgeb√ºhr (40 ‚Ç¨)</span>
            <input type="checkbox" name="connectionFee" />
          </label>
        </div>
        <div class="grid two">
          <label>
            Datenvolumen (GB)
            <input type="number" name="data" min="0" step="0.1" placeholder="z.B. 20" />
          </label>
          <label>
            Minuten/SMS Flat
            <select name="flat">
              <option value="ja">Ja</option>
              <option value="nein">Nein</option>
            </select>
          </label>
        </div>
        <div class="grid two">
          <label>
            Handy
            <select name="device" id="device-select"></select>
          </label>
          <label>
            Direktlink
            <input type="url" name="link" placeholder="https://‚Ä¶" />
          </label>
        </div>
        <div id="new-device-wrapper" class="hidden">
          <label>
            Neues Handy speichern
            <input type="text" id="new-device-input" placeholder="z.B. iPhone 15" />
          </label>
        </div>
        <div>
          <label>
            Notizen
            <input type="text" name="notes" placeholder="z.B. inkl. EU-Roaming" />
          </label>
        </div>
        <div class="form-actions">
          <button type="button" class="button-secondary hidden" id="cancel-edit">Abbrechen</button>
          <button type="submit" id="submit-button">Vertrag hinzuf√ºgen</button>
        </div>
      </form>
    </section>

    <section class="card">
      <h2>√úberblick</h2>
      <div id="overview">
        <p class="empty">Noch keine Vertr√§ge eingetragen.</p>
      </div>
    </section>
  </main>

  <div id="import-overlay" class="modal-overlay hidden">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="import-title">
      <header>
        <h3 id="import-title">Vertrag importieren</h3>
      </header>
      <div class="modal-body">
        <div>
          <label for="import-textarea" style="display:block; font-weight:600; margin-bottom:8px;">Importstring</label>
          <textarea id="import-textarea" placeholder="Anbieter\tTarifname\tMonatlich ..."></textarea>
        </div>
        <div style="display:flex; justify-content:flex-end;">
          <button type="button" id="import-preview">Preview anzeigen</button>
        </div>
        <p id="import-error" class="error-message hidden"></p>
        <div class="import-preview hidden" id="import-preview-wrapper">
          <table>
            <thead>
              <tr>
                <th>Feldname</th>
                <th>Wert</th>
              </tr>
            </thead>
            <tbody id="import-preview-body"></tbody>
          </table>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="button-secondary" id="import-cancel">Abbrechen</button>
        <button type="button" id="import-confirm" disabled>Import √ºbernehmen</button>
      </div>
    </div>
  </div>

  <template id="table-template">
    <div class="grid">
      <div class="summary">
        <div class="summary-item">
          <span>G√ºnstigste monatliche Belastung</span>
          <span id="lowest-monthly"></span>
        </div>
        <div class="summary-item">
          <span>Niedrigste Gesamtkosten</span>
          <span id="lowest-total"></span>
        </div>
        <div class="summary-item">
          <span>Durchschnittliche monatliche Kosten</span>
          <span id="average-monthly"></span>
        </div>
      </div>
      <section id="selected-contract" class="selected-contract hidden">
        <div class="selected-contract-header">
          <div>
            <h3 id="selected-contract-title"></h3>
            <p id="selected-contract-subtitle"></p>
          </div>
          <div class="selected-contract-actions">
            <button type="button" id="selected-update">Aktualisieren</button>
            <button type="button" class="button-secondary" id="selected-clear">Clear</button>
          </div>
        </div>
        <div class="selected-contract-grid">
          <div class="selected-field">
            <span class="selected-label">Monatlich</span>
            <span class="selected-value" id="selected-monthly"></span>
          </div>
          <div class="selected-field">
            <span class="selected-label">Effektiv / Monat</span>
            <span class="selected-value" id="selected-effective"></span>
          </div>
          <div class="selected-field">
            <span class="selected-label">Gesamtkosten</span>
            <span class="selected-value" id="selected-total"></span>
          </div>
          <div class="selected-field">
            <span class="selected-label">Einmalig</span>
            <span class="selected-value" id="selected-upfront"></span>
          </div>
          <div class="selected-field">
            <span class="selected-label">Laufzeit</span>
            <span class="selected-value" id="selected-duration"></span>
          </div>
          <div class="selected-field">
            <span class="selected-label">Handy</span>
            <span class="selected-value" id="selected-device"></span>
          </div>
          <div class="selected-field">
            <span class="selected-label">Bonus</span>
            <span class="selected-value" id="selected-bonus"></span>
          </div>
        </div>
        <div>
          <a id="selected-link" class="selected-link" href="#" target="_blank" rel="noopener"></a>
        </div>
        <p id="selected-notes" class="selected-notes"></p>
      </section>
      <div class="table-controls">
        <label for="sort-select">Sortieren nach</label>
        <select id="sort-select">
          <option value="effective-asc">Effektiv / Monat (aufsteigend)</option>
          <option value="effective-desc">Effektiv / Monat (absteigend)</option>
          <option value="total-asc">Gesamtkosten (aufsteigend)</option>
          <option value="total-desc">Gesamtkosten (absteigend)</option>
          <option value="monthly-asc">Monatspreis (aufsteigend)</option>
          <option value="monthly-desc">Monatspreis (absteigend)</option>
          <option value="provider-asc">Anbieter (A‚ÄìZ)</option>
          <option value="provider-desc">Anbieter (Z‚ÄìA)</option>
          <option value="created">Eingabereihenfolge</option>
        </select>
      </div>
      <div class="table-wrapper">
        <div class="comparison-table" role="table" aria-label="Tarifvergleich">
          <div class="table-row table-header" role="row">
            <div class="cell cell--provider" role="columnheader">Anbieter &amp; Tarif</div>
            <div class="cell cell--device" role="columnheader">Handy</div>
            <div class="cell cell--monthly" role="columnheader">Monatlich</div>
            <div class="cell cell--upfront" role="columnheader">Einmalig</div>
            <div class="cell cell--bonus" role="columnheader">Bonus</div>
            <div class="cell cell--duration" role="columnheader">Laufzeit</div>
            <div class="cell cell--total" role="columnheader">Gesamtkosten</div>
            <div class="cell cell--effective" role="columnheader">Effektiv / Monat</div>
            <div class="cell cell--details" role="columnheader">Details</div>
            <div class="cell cell--actions" role="columnheader">Aktionen</div>
          </div>
          <div id="contract-table" class="table-body" role="rowgroup"></div>
        </div>
      </div>
    </div>
  </template>

  <template id="row-template">
    <div class="table-row" role="row">
      <div class="cell cell--provider" data-label="Anbieter &amp; Tarif" role="cell">
        <div class="provider-stack">
          <strong class="name"></strong>
          <span class="tag data"></span>
        </div>
      </div>
      <div class="cell cell--device device" data-label="Handy" role="cell"></div>
      <div class="cell cell--monthly monthly" data-label="Monatlich" role="cell"></div>
      <div class="cell cell--upfront upfront" data-label="Einmalig" role="cell"></div>
      <div class="cell cell--bonus bonus" data-label="Bonus" role="cell"></div>
      <div class="cell cell--duration duration" data-label="Laufzeit" role="cell"></div>
      <div class="cell cell--total total" data-label="Gesamtkosten" role="cell"></div>
      <div class="cell cell--effective effective" data-label="Effektiv / Monat" role="cell"></div>
      <div class="cell cell--details notes" data-label="Details" role="cell">
        <button type="button" class="details-button" aria-label="Details anzeigen">
          <span aria-hidden="true">‚ÑπÔ∏è</span>
        </button>
      </div>
      <div class="cell cell--actions" data-label="Aktionen" role="cell">
        <div class="actions-group">
          <button type="button" class="button-ghost button-small edit-button">Bearbeiten</button>
          <button type="button" class="button-danger button-small delete-button">L√∂schen</button>
        </div>
      </div>
    </div>
  </template>

  <script>
    const form = document.getElementById('contract-form');
    const overview = document.getElementById('overview');
    const tableTemplate = document.getElementById('table-template');
    const rowTemplate = document.getElementById('row-template');
    const deviceSelect = document.getElementById('device-select');
    const newDeviceWrapper = document.getElementById('new-device-wrapper');
    const newDeviceInput = document.getElementById('new-device-input');
    const submitButton = document.getElementById('submit-button');
    const cancelEditButton = document.getElementById('cancel-edit');
    const exportButton = document.getElementById('export-contracts');

    const importOpenButton = document.getElementById('open-import');
    const importOverlay = document.getElementById('import-overlay');
    const importTextarea = document.getElementById('import-textarea');
    const importPreviewButton = document.getElementById('import-preview');
    const importPreviewWrapper = document.getElementById('import-preview-wrapper');
    const importPreviewBody = document.getElementById('import-preview-body');
    const importError = document.getElementById('import-error');
    const importCancel = document.getElementById('import-cancel');
    const importConfirm = document.getElementById('import-confirm');

    const importFields = [
      { key: 'anbieter', label: 'Anbieter' },
      { key: 'tarif', label: 'Tarifname' },
      { key: 'monatlich', label: 'Monatlich (‚Ç¨)' },
      { key: 'einmalig', label: 'Einmalig (‚Ç¨)' },
      { key: 'laufzeit', label: 'Laufzeit (Monate)' },
      { key: 'bonus', label: 'Bonus (‚Ç¨)' },
      { key: 'anschluss', label: 'Anschlussgeb√ºhr (‚Ç¨)' },
      { key: 'datenvolumen', label: 'Datenvolumen (GB)' },
      { key: 'flat', label: 'Minuten/SMS Flat' },
      { key: 'handy', label: 'Handy' },
      { key: 'link', label: 'Direktlink' },
      { key: 'notizen', label: 'Notizen' },
    ];

    let parsedImport = null;

    function resetImportModal() {
      importTextarea.value = '';
      importError.textContent = '';
      importError.classList.add('hidden');
      importPreviewWrapper.classList.add('hidden');
      importPreviewBody.innerHTML = '';
      importConfirm.disabled = true;
      importConfirm.textContent = 'Import √ºbernehmen';
      parsedImport = null;
    }

    function openImportModal() {
      resetImportModal();
      importOverlay.classList.remove('hidden');
      setTimeout(() => {
        importTextarea.focus();
      }, 0);
    }

    function closeImportModal() {
      importOverlay.classList.add('hidden');
      resetImportModal();
    }

    function parseImportString(raw) {
      const input = typeof raw === 'string' ? raw : '';

      if (!input.trim()) {
        throw new Error('Bitte gib einen Importstring ein.');
      }

      const lines = input
        .split(/\r?\n/)
        .map(entry => entry.replace(/\r/g, ''))
        .filter(entry => entry.trim().length > 0);

      if (!lines.length) {
        throw new Error('Der Importstring ist leer.');
      }

      return lines.map((line, index) => {
        const values = line.split('\t');
        if (values.length !== importFields.length) {
          throw new Error(`Zeile ${index + 1} muss genau ${importFields.length} Werte enthalten.`);
        }

        const [
          anbieter,
          tarif,
          monatlich,
          einmalig,
          laufzeit,
          bonus,
          anschluss,
          datenvolumen,
          flat,
          handy,
          link,
          notizen,
        ] = values.map(value => value.trim());

        return {
          anbieter,
          tarif,
          monatlich,
          einmalig,
          laufzeit,
          bonus,
          anschluss,
          datenvolumen,
          flat,
          handy,
          link,
          notizen,
        };
      });
    }

    function renderImportPreview(entries) {
      importPreviewBody.innerHTML = '';

      const currencyFormatter = new Intl.NumberFormat('de-DE', {
        style: 'currency',
        currency: 'EUR',
      });

      const parseEssentialNumber = value => {
        const normalized = toNumberString(value);
        if (!normalized) {
          return NaN;
        }
        const parsed = Number(normalized);
        return Number.isFinite(parsed) ? parsed : NaN;
      };

      const parseOptionalNumber = value => {
        const normalized = toNumberString(value);
        if (!normalized) {
          return 0;
        }
        const parsed = Number(normalized);
        return Number.isFinite(parsed) ? parsed : NaN;
      };

      const computedValues = entries.map(entry => {
        const monthly = parseEssentialNumber(entry.monatlich);
        const duration = parseEssentialNumber(entry.laufzeit);
        const upfront = parseOptionalNumber(entry.einmalig);
        const bonus = parseOptionalNumber(entry.bonus);
        const connectionFee = parseOptionalNumber(entry.anschluss);

        const totalCost = monthly * duration + upfront + connectionFee - bonus;
        const effectiveMonthly =
          Number.isFinite(totalCost) && Number.isFinite(duration) && duration !== 0
            ? totalCost / duration
            : NaN;

        return { totalCost, effectiveMonthly };
      });

      const validTotals = computedValues
        .map(value => value.totalCost)
        .filter(value => Number.isFinite(value));
      const validEffectives = computedValues
        .map(value => value.effectiveMonthly)
        .filter(value => Number.isFinite(value));

      const averageTotal =
        validTotals.length > 0
          ? validTotals.reduce((sum, value) => sum + value, 0) / validTotals.length
          : NaN;
      const averageEffective =
        validEffectives.length > 0
          ? validEffectives.reduce((sum, value) => sum + value, 0) /
            validEffectives.length
          : NaN;

      const formatCurrency = value =>
        Number.isFinite(value) ? currencyFormatter.format(value) : '‚Äî';

      entries.forEach((entry, entryIndex) => {
        if (entries.length > 1) {
          const headerRow = document.createElement('tr');
          headerRow.className = 'entry-header';
          const headerCell = document.createElement('td');
          headerCell.colSpan = 2;
          headerCell.textContent = `Vertrag ${entryIndex + 1}`;
          headerRow.appendChild(headerCell);
          importPreviewBody.appendChild(headerRow);
        }

        importFields.forEach(field => {
          const row = document.createElement('tr');
          const labelCell = document.createElement('td');
          labelCell.textContent = field.label;
          const valueCell = document.createElement('td');
          valueCell.textContent = entry[field.key] || '‚Äî';
          row.append(labelCell, valueCell);
          importPreviewBody.appendChild(row);
        });

        const { totalCost, effectiveMonthly } = computedValues[entryIndex];

        const appendCalculationRow = (label, value, average) => {
          const row = document.createElement('tr');
          const labelCell = document.createElement('td');
          labelCell.textContent = label;
          const valueCell = document.createElement('td');
          valueCell.textContent = formatCurrency(value);
          row.append(labelCell, valueCell);

          if (
            Number.isFinite(value) &&
            Number.isFinite(average) &&
            value < average
          ) {
            row.style.backgroundColor = 'rgba(0, 200, 0, 0.1)';
          }

          importPreviewBody.appendChild(row);
        };

        appendCalculationRow('Gesamtkosten (√ºber Laufzeit)', totalCost, averageTotal);
        appendCalculationRow('Effektiv pro Monat', effectiveMonthly, averageEffective);
      });

      if (importConfirm) {
        importConfirm.textContent = entries.length > 1 ? 'Vertr√§ge ersetzen' : 'Vertrag importieren';
      }

      importPreviewWrapper.classList.remove('hidden');
    }

    function toNumberString(value) {
      const str = (value || '').toString().trim();
      if (!str) {
        return '';
      }
      return str.replace(',', '.');
    }

    function addDeviceIfMissing(deviceName) {
      const trimmed = (deviceName || '').trim();
      if (!trimmed) {
        return { name: '', added: false };
      }

      if (!devices.includes(trimmed)) {
        devices.push(trimmed);
        devices.sort((a, b) => a.localeCompare(b, 'de', { sensitivity: 'base' }));
        return { name: trimmed, added: true };
      }

      return { name: trimmed, added: false };
    }

    function createContractFromImport(entry) {
      const provider = (entry.anbieter || '').trim();
      const plan = (entry.tarif || '').trim();
      const monthly = Number(toNumberString(entry.monatlich)) || 0;
      const upfront = Number(toNumberString(entry.einmalig)) || 0;
      const duration = Number(toNumberString(entry.laufzeit)) || 0;
      const bonus = Number(toNumberString(entry.bonus)) || 0;
      const connectionFeeAmount = Number(toNumberString(entry.anschluss)) || 0;
      const dataVolume = toNumberString(entry.datenvolumen);
      const flatValue = (entry.flat || '').toString().trim().toLowerCase();
      const device = (entry.handy || '').trim();
      const link = (entry.link || '').trim();
      const notes = (entry.notizen || '').trim();

      const contract = {
        provider,
        plan,
        monthly,
        upfront,
        duration,
        bonus,
        connectionFeeAmount,
        data: dataVolume,
        flat: flatValue === 'ja' ? 'ja' : 'nein',
        device,
        link,
        notes,
      };

      updateContractCalculations(contract);

      return contract;
    }

    function applyImportEntries(entries) {
      if (!entries.length) {
        return { mode: 'none', count: 0 };
      }

      const previousSelection = deviceSelect.value;
      let devicesUpdated = false;

      const importedContracts = entries.map(entry => {
        const contract = createContractFromImport(entry);
        const { name: deviceName, added } = addDeviceIfMissing(contract.device);
        if (added) {
          devicesUpdated = true;
        }
        contract.device = deviceName;
        return contract;
      }).filter(contract => contract.provider || contract.plan || contract.monthly || contract.upfront || contract.duration || contract.bonus || contract.device || contract.link || contract.notes);

      if (!importedContracts.length) {
        return { mode: 'none', count: 0 };
      }

      if (importedContracts.length === 1) {
        const singleContract = importedContracts[0];
        if (devicesUpdated) {
          saveDevices();
        }

        resetFormState(previousSelection);

        contracts.push(singleContract);
        saveContracts();
        render();

        return { mode: 'append', count: 1 };
      }

      if (devicesUpdated) {
        saveDevices();
      }

      resetFormState('');

      contracts.length = 0;
      contracts.push(...importedContracts);
      saveContracts();
      render();

      return { mode: 'replace', count: importedContracts.length };
    }

    function exportValue(value, { decimal = false } = {}) {
      if (value === null || value === undefined) {
        return '';
      }

      let stringValue = '';

      if (typeof value === 'number') {
        if (!Number.isFinite(value)) {
          return '';
        }
        stringValue = value.toString();
      } else {
        stringValue = value.toString();
      }

      if (decimal) {
        stringValue = stringValue.replace(/\./g, ',');
      }

      return stringValue.replace(/\t/g, ' ').replace(/\r?\n/g, ' / ').trim();
    }

    function buildExportContent() {
      if (!contracts.length) {
        return '';
      }

      const rows = contracts.map(contract => {
        return [
          exportValue(contract.provider),
          exportValue(contract.plan),
          exportValue(contract.monthly, { decimal: true }),
          exportValue(contract.upfront, { decimal: true }),
          exportValue(contract.duration),
          exportValue(contract.bonus, { decimal: true }),
          exportValue(contract.connectionFeeAmount, { decimal: true }),
          exportValue(contract.data),
          exportValue(contract.flat),
          exportValue(contract.device),
          exportValue(contract.link),
          exportValue(contract.notes),
        ].join('\t');
      });

      return rows.join('\n');
    }

    if (exportButton) {
      exportButton.addEventListener('click', () => {
        const content = buildExportContent();
        if (!content) {
          window.alert('Es gibt keine Vertr√§ge zum Exportieren.');
          return;
        }

        const blob = new Blob([content], {
          type: 'text/tab-separated-values;charset=utf-8;',
        });
        const url = URL.createObjectURL(blob);
        const timestamp = new Date().toISOString().slice(0, 10);
        const link = document.createElement('a');
        link.href = url;
        link.download = `handyrechner-export-${timestamp}.tsv`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
      });
    }

    importOpenButton.addEventListener('click', () => {
      openImportModal();
    });

    importCancel.addEventListener('click', () => {
      closeImportModal();
    });

    importOverlay.addEventListener('click', event => {
      if (event.target === importOverlay) {
        closeImportModal();
      }
    });

    document.addEventListener('keydown', event => {
      if (event.key === 'Escape' && !importOverlay.classList.contains('hidden')) {
        closeImportModal();
      }
    });

    importPreviewButton.addEventListener('click', () => {
      try {
        const parsed = parseImportString(importTextarea.value);
        parsedImport = parsed;
        renderImportPreview(parsed);
        importError.classList.add('hidden');
        importError.textContent = '';
        importConfirm.disabled = false;
      } catch (error) {
        parsedImport = null;
        importPreviewWrapper.classList.add('hidden');
        importPreviewBody.innerHTML = '';
        importError.textContent = error.message;
        importError.classList.remove('hidden');
        importConfirm.disabled = true;
        importConfirm.textContent = 'Import √ºbernehmen';
      }
    });

    importConfirm.addEventListener('click', () => {
      if (!Array.isArray(parsedImport) || !parsedImport.length) {
        return;
      }
      const result = applyImportEntries(parsedImport);
      parsedImport = null;
      closeImportModal();

      if (result.mode === 'append' && result.count === 1) {
        window.alert('1 Vertrag wurde importiert.');
      } else if (result.mode === 'replace' && result.count) {
        window.alert(`${result.count} Vertr√§ge wurden importiert und vorhandene ersetzt.`);
      }
    });

    importTextarea.addEventListener('input', () => {
      parsedImport = null;
      importConfirm.disabled = true;
      importPreviewWrapper.classList.add('hidden');
      importPreviewBody.innerHTML = '';
      importError.classList.add('hidden');
      importError.textContent = '';
      importConfirm.textContent = 'Import √ºbernehmen';
    });

    const STORAGE_KEY = 'handyvertrag-contracts';
    const SORT_STORAGE_KEY = 'handyrechner-sort';
    const SORT_DEFAULT = 'effective-asc';
    const VALID_SORTS = new Set([
      'effective-asc',
      'effective-desc',
      'total-asc',
      'total-desc',
      'monthly-asc',
      'monthly-desc',
      'provider-asc',
      'provider-desc',
      'created',
    ]);

    function loadContracts() {
      try {
        const stored = localStorage.getItem(STORAGE_KEY);
        const parsed = stored ? JSON.parse(stored) : [];
        return Array.isArray(parsed) ? parsed : [];
      } catch (error) {
        console.warn('Konnte gespeicherte Vertr√§ge nicht laden:', error);
        return [];
      }
    }

    function saveContracts() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(contracts));
    }

    function loadSortPreference() {
      try {
        const stored = localStorage.getItem(SORT_STORAGE_KEY);
        return stored && VALID_SORTS.has(stored) ? stored : SORT_DEFAULT;
      } catch (error) {
        console.warn('Sortierung konnte nicht geladen werden.', error);
        return SORT_DEFAULT;
      }
    }

    function saveSortPreference(sort) {
      try {
        localStorage.setItem(SORT_STORAGE_KEY, sort);
      } catch (error) {
        console.warn('Sortierung konnte nicht gespeichert werden.', error);
      }
    }

    function updateContractCalculations(contract) {
      const monthly = Number(contract.monthly) || 0;
      const upfront = Number(contract.upfront) || 0;
      const duration = Number(contract.duration) || 0;
      const bonus = Number(contract.bonus) || 0;
      const connectionFeeAmount = Number(contract.connectionFeeAmount) || 0;

      const total = monthly * duration + upfront + connectionFeeAmount - bonus;

      contract.monthly = monthly;
      contract.upfront = upfront;
      contract.duration = duration;
      contract.bonus = bonus;
      contract.connectionFeeAmount = connectionFeeAmount;
      contract.total = total;
      contract.effective = duration ? total / duration : 0;
    }

    function sortContractEntries(entries, sortKey) {
      if (!VALID_SORTS.has(sortKey) || sortKey === 'created') {
        return entries;
      }

      const sorted = [...entries];
      const comparator = getSortComparator(sortKey);
      if (comparator) {
        sorted.sort(comparator);
      }
      return sorted;
    }

    function getSortComparator(sortKey) {
      switch (sortKey) {
        case 'effective-asc':
          return (a, b) => a.contract.effective - b.contract.effective || a.index - b.index;
        case 'effective-desc':
          return (a, b) => b.contract.effective - a.contract.effective || a.index - b.index;
        case 'total-asc':
          return (a, b) => a.contract.total - b.contract.total || a.index - b.index;
        case 'total-desc':
          return (a, b) => b.contract.total - a.contract.total || a.index - b.index;
        case 'monthly-asc':
          return (a, b) => a.contract.monthly - b.contract.monthly || a.index - b.index;
        case 'monthly-desc':
          return (a, b) => b.contract.monthly - a.contract.monthly || a.index - b.index;
        case 'provider-asc':
          return (a, b) => {
            const providerA = (a.contract.provider || '').toString();
            const providerB = (b.contract.provider || '').toString();
            const planA = (a.contract.plan || '').toString();
            const planB = (b.contract.plan || '').toString();
            return (
              providerA.localeCompare(providerB, 'de', { sensitivity: 'base' }) ||
              planA.localeCompare(planB, 'de', { sensitivity: 'base' }) ||
              a.index - b.index
            );
          };
        case 'provider-desc':
          return (a, b) => {
            const providerA = (a.contract.provider || '').toString();
            const providerB = (b.contract.provider || '').toString();
            const planA = (a.contract.plan || '').toString();
            const planB = (b.contract.plan || '').toString();
            return (
              providerB.localeCompare(providerA, 'de', { sensitivity: 'base' }) ||
              planB.localeCompare(planA, 'de', { sensitivity: 'base' }) ||
              a.index - b.index
            );
          };
        default:
          return null;
      }
    }

    function buildNotesCell(cell, contract, index) {
      const detailsButton = cell.querySelector('.details-button');

      if (!detailsButton) {
        return;
      }

      const details = [];

      if (contract.link) {
        details.push('Direktlink verf√ºgbar');
      }

      if (contract.connectionFeeAmount) {
        details.push('Anschlussgeb√ºhr enthalten');
      }

      if (contract.notes) {
        details.push(contract.notes);
      }

      if (!details.length) {
        detailsButton.disabled = true;
        detailsButton.removeAttribute('data-tooltip');
        detailsButton.removeAttribute('title');
        detailsButton.setAttribute('aria-label', 'Keine zus√§tzlichen Details verf√ºgbar');
        return;
      }

      const tooltip = details.map(entry => `‚Ä¢ ${entry}`).join('\n');
      detailsButton.disabled = false;
      detailsButton.dataset.tooltip = tooltip;
      detailsButton.title = details.join('\n');
      detailsButton.setAttribute('aria-label', 'Weitere Vertragsdetails anzeigen');

      detailsButton.addEventListener('click', event => {
        event.stopPropagation();

        if (event.metaKey || event.ctrlKey) {
          if (contract.link) {
            window.open(contract.link, '_blank', 'noopener');
          }
          return;
        }

        if (selectedIndex !== index) {
          selectedIndex = index;
          render();
          return;
        }

        if (contract.link) {
          window.open(contract.link, '_blank', 'noopener');
        }
      });
    }

    const contracts = loadContracts();
    contracts.forEach(updateContractCalculations);
    let currentSort = loadSortPreference();

    const deviceStorageKey = 'handyrechner-devices';
    let devices = [];

    try {
      const storedDevices = localStorage.getItem(deviceStorageKey);
      if (storedDevices) {
        const parsed = JSON.parse(storedDevices);
        if (Array.isArray(parsed)) {
          devices = parsed
            .map(device => (typeof device === 'string' ? device.trim() : ''))
            .filter(device => device);
        }
      }
    } catch (error) {
      console.warn('Gespeicherte Ger√§te konnten nicht geladen werden.', error);
    }

    function saveDevices() {
      try {
        localStorage.setItem(deviceStorageKey, JSON.stringify(devices));
      } catch (error) {
        console.warn('Ger√§teliste konnte nicht gespeichert werden.', error);
      }
    }

    function populateDeviceOptions(selected = '') {
      deviceSelect.innerHTML = '';

      const placeholder = document.createElement('option');
      placeholder.value = '';
      placeholder.textContent = 'Handy w√§hlen (optional)';
      deviceSelect.appendChild(placeholder);

      devices.forEach(device => {
        const option = document.createElement('option');
        option.value = device;
        option.textContent = device;
        deviceSelect.appendChild(option);
      });

      const createOption = document.createElement('option');
      createOption.value = '__new__';
      createOption.textContent = 'Neues Handy hinzuf√ºgen‚Ä¶';
      deviceSelect.appendChild(createOption);

      const availableOption = Array.from(deviceSelect.options).find(
        option => option.value === selected
      );

      deviceSelect.value = availableOption ? selected : '';
    }

    function showNewDeviceInput(show) {
      if (show) {
        newDeviceWrapper.classList.remove('hidden');
        newDeviceInput.focus();
      } else {
        newDeviceWrapper.classList.add('hidden');
        newDeviceInput.value = '';
      }
    }

    deviceSelect.addEventListener('change', () => {
      showNewDeviceInput(deviceSelect.value === '__new__');
    });

    const euro = new Intl.NumberFormat('de-DE', {
      style: 'currency',
      currency: 'EUR',
    });

    let editingIndex = null;
    let selectedIndex = null;

    function render() {
      overview.innerHTML = '';

      if (!contracts.length) {
        overview.innerHTML = '<p class="empty">Noch keine Vertr√§ge eingetragen.</p>';
        selectedIndex = null;
        return;
      }

      if (!VALID_SORTS.has(currentSort)) {
        currentSort = SORT_DEFAULT;
      }

      if (selectedIndex !== null && (selectedIndex < 0 || selectedIndex >= contracts.length)) {
        selectedIndex = null;
      }

      const contractEntries = contracts.map((contract, index) => {
        updateContractCalculations(contract);
        return { contract, index };
      });

      const sortedEntries = sortContractEntries(contractEntries, currentSort);

      const fragment = tableTemplate.content.cloneNode(true);
      const tbody = fragment.getElementById('contract-table');
      const sortSelect = fragment.getElementById('sort-select');
      const selectedContainer = fragment.getElementById('selected-contract');
      const selectedTitleEl = fragment.getElementById('selected-contract-title');
      const selectedSubtitleEl = fragment.getElementById('selected-contract-subtitle');
      const selectedMonthlyEl = fragment.getElementById('selected-monthly');
      const selectedEffectiveEl = fragment.getElementById('selected-effective');
      const selectedTotalEl = fragment.getElementById('selected-total');
      const selectedUpfrontEl = fragment.getElementById('selected-upfront');
      const selectedDurationEl = fragment.getElementById('selected-duration');
      const selectedDeviceEl = fragment.getElementById('selected-device');
      const selectedBonusEl = fragment.getElementById('selected-bonus');
      const selectedLinkEl = fragment.getElementById('selected-link');
      const selectedNotesEl = fragment.getElementById('selected-notes');
      const selectedUpdateButton = fragment.getElementById('selected-update');
      const selectedClearButton = fragment.getElementById('selected-clear');

      if (sortSelect) {
        sortSelect.value = currentSort;
        sortSelect.addEventListener('change', event => {
          const nextSort = event.target.value;
          currentSort = VALID_SORTS.has(nextSort) ? nextSort : SORT_DEFAULT;
          saveSortPreference(currentSort);
          render();
        });
      }

      let lowestMonthly = { value: Infinity, row: null };
      let lowestTotal = { value: Infinity, row: null };
      let monthlySum = 0;

      sortedEntries.forEach(({ contract, index }) => {
        const row = rowTemplate.content.cloneNode(true);
        const rowEl = row.querySelector('.table-row');

        if (rowEl) {
          rowEl.classList.add('selectable');

          if (index === editingIndex) {
            rowEl.classList.add('editing');
          }

          if (index === selectedIndex) {
            rowEl.classList.add('selected');
          }
        }

        const name = row.querySelector('.name');
        name.textContent = `${contract.provider} ‚Äì ${contract.plan}`;

        const dataTag = row.querySelector('.data');
        const dataText = contract.data ? `${contract.data} GB` : 'Datenvolumen n. a.';
        dataTag.textContent = `${dataText}${contract.flat === 'ja' ? ' ¬∑ Allnet-Flat' : ''}`;

        row.querySelector('.monthly').textContent = euro.format(contract.monthly);
        const bonusValue = Number(contract.bonus) || 0;
        row.querySelector('.bonus').textContent = bonusValue
          ? `‚àí ${euro.format(bonusValue)}`
          : '‚Äî';
        const upfrontSum = (contract.upfront || 0) + (contract.connectionFeeAmount || 0);
        row.querySelector('.upfront').textContent = euro.format(upfrontSum);

        row.querySelector('.duration').textContent = `${contract.duration} Monate`;
        row.querySelector('.total').textContent = euro.format(contract.total);
        row.querySelector('.effective').textContent = euro.format(contract.effective);
        row.querySelector('.device').textContent = contract.device || '‚Äî';

        const notesCell = row.querySelector('.notes');
        buildNotesCell(notesCell, contract, index);

        const editButton = row.querySelector('.edit-button');
        if (editButton) {
          editButton.addEventListener('click', event => {
            event.stopPropagation();
            startEdit(index);
          });
        }

        const deleteButton = row.querySelector('.delete-button');
        if (deleteButton) {
          deleteButton.addEventListener('click', event => {
            event.stopPropagation();
            deleteContract(index);
          });
        }

        if (rowEl) {
          rowEl.addEventListener('click', event => {
            if (event.target.closest('button') || event.target.closest('a')) {
              return;
            }

            if (selectedIndex !== index) {
              selectedIndex = index;
              render();
            }
          });
        }

        tbody.appendChild(row);

        monthlySum += contract.effective;

        if (contract.effective < lowestMonthly.value) {
          lowestMonthly = { value: contract.effective, row: rowEl };
        }

        if (contract.total < lowestTotal.value) {
          lowestTotal = { value: contract.total, row: rowEl };
        }
      });

      const lowestMonthlyEl = fragment.getElementById('lowest-monthly');
      const lowestTotalEl = fragment.getElementById('lowest-total');
      const avgMonthlyEl = fragment.getElementById('average-monthly');

      lowestMonthlyEl.textContent = euro.format(lowestMonthly.value);
      lowestTotalEl.textContent = euro.format(lowestTotal.value);
      avgMonthlyEl.textContent = euro.format(monthlySum / contracts.length);

      if (lowestMonthly.row) {
        lowestMonthly.row.classList.add('highlight');
      }

      if (lowestTotal.row) {
        lowestTotal.row.classList.add('highlight');
      }

      const selectedContract =
        selectedIndex !== null ? contracts[selectedIndex] || null : null;

      if (selectedContainer) {
        const hasSelection = Boolean(selectedContract);
        selectedContainer.classList.toggle('hidden', !hasSelection);

        if (hasSelection && selectedContract) {
          const provider = selectedContract.provider || 'Unbekannter Anbieter';
          const plan = selectedContract.plan || 'Unbekannter Tarif';
          if (selectedTitleEl) {
            selectedTitleEl.textContent = `${provider} ‚Äì ${plan}`;
          }

          if (selectedSubtitleEl) {
            const subtitleParts = [];
            const dataText = selectedContract.data
              ? `${selectedContract.data} GB`
              : 'Datenvolumen n. a.';
            subtitleParts.push(dataText);

            if (selectedContract.flat === 'ja') {
              subtitleParts.push('Allnet-Flat');
            }

            if (selectedContract.device) {
              subtitleParts.push(`Handy: ${selectedContract.device}`);
            }

            selectedSubtitleEl.textContent = subtitleParts.join(' ¬∑ ');
          }

          if (selectedMonthlyEl) {
            selectedMonthlyEl.textContent = euro.format(selectedContract.monthly || 0);
          }

          if (selectedEffectiveEl) {
            selectedEffectiveEl.textContent = euro.format(selectedContract.effective || 0);
          }

          if (selectedTotalEl) {
            selectedTotalEl.textContent = euro.format(selectedContract.total || 0);
          }

          if (selectedUpfrontEl) {
            const upfrontSum = (selectedContract.upfront || 0) + (selectedContract.connectionFeeAmount || 0);
            selectedUpfrontEl.textContent = euro.format(upfrontSum);
          }

          if (selectedDurationEl) {
            selectedDurationEl.textContent = selectedContract.duration
              ? `${selectedContract.duration} Monate`
              : '‚Äî';
          }

          if (selectedDeviceEl) {
            selectedDeviceEl.textContent = selectedContract.device || '‚Äî';
          }

          if (selectedBonusEl) {
            const bonusValue = Number(selectedContract.bonus) || 0;
            selectedBonusEl.textContent = bonusValue
              ? `‚àí ${euro.format(bonusValue)}`
              : '‚Äî';
          }

          if (selectedNotesEl) {
            if (selectedContract.notes) {
              selectedNotesEl.textContent = selectedContract.notes;
              selectedNotesEl.classList.remove('hidden');
            } else {
              selectedNotesEl.textContent = '';
              selectedNotesEl.classList.add('hidden');
            }
          }

          if (selectedLinkEl) {
            if (selectedContract.link) {
              selectedLinkEl.href = selectedContract.link;
              selectedLinkEl.textContent = 'Zum Angebot';
              selectedLinkEl.classList.remove('hidden');
            } else {
              selectedLinkEl.removeAttribute('href');
              selectedLinkEl.textContent = '';
              selectedLinkEl.classList.add('hidden');
            }
          }
        }
      }

      if (selectedUpdateButton) {
        selectedUpdateButton.addEventListener('click', () => {
          if (selectedIndex !== null) {
            startEdit(selectedIndex);
          }
        });
      }

      if (selectedClearButton) {
        selectedClearButton.addEventListener('click', () => {
          selectedIndex = null;
          render();
        });
      }

      overview.appendChild(fragment);
    }

    function resetFormState(selectedDevice = '') {
      form.reset();
      editingIndex = null;
      submitButton.textContent = 'Vertrag hinzuf√ºgen';
      cancelEditButton.classList.add('hidden');
      populateDeviceOptions(selectedDevice);
      showNewDeviceInput(false);
      newDeviceInput.value = '';
    }

    function fillFormWithContract(contract) {
      form.elements['provider'].value = contract.provider || '';
      form.elements['plan'].value = contract.plan || '';
      form.elements['monthly'].value = contract.monthly ?? '';
      form.elements['upfront'].value = contract.upfront ?? '';
      form.elements['duration'].value = contract.duration ?? '';
      form.elements['bonus'].value = contract.bonus ?? '';
      form.elements['connectionFee'].checked = (contract.connectionFeeAmount || 0) > 0;
      form.elements['data'].value = contract.data ?? '';
      form.elements['flat'].value = contract.flat === 'nein' ? 'nein' : 'ja';
      form.elements['device'].value = contract.device || '';
      form.elements['link'].value = contract.link || '';
      form.elements['notes'].value = contract.notes || '';
      showNewDeviceInput(false);
      newDeviceInput.value = '';
    }

    function startEdit(index) {
      const contract = contracts[index];
      if (!contract) {
        return;
      }

      editingIndex = index;
      selectedIndex = index;

      if (contract.device && !devices.includes(contract.device)) {
        devices.push(contract.device);
        devices.sort((a, b) => a.localeCompare(b, 'de', { sensitivity: 'base' }));
        saveDevices();
      }

      populateDeviceOptions(contract.device || '');
      fillFormWithContract(contract);
      submitButton.textContent = 'Vertrag aktualisieren';
      cancelEditButton.classList.remove('hidden');
      form.scrollIntoView({ behavior: 'smooth', block: 'start' });
      render();
    }

    function deleteContract(index) {
      const contract = contracts[index];
      if (!contract) {
        return;
      }

      const provider = contract.provider || 'Unbekannter Anbieter';
      const plan = contract.plan || 'Unbekannter Tarif';
      const message = `Soll der Tarif "${provider} ‚Äì ${plan}" wirklich gel√∂scht werden?`;

      if (!window.confirm(message)) {
        return;
      }

      contracts.splice(index, 1);

      if (editingIndex !== null) {
        if (editingIndex === index) {
          resetFormState();
        } else if (editingIndex > index) {
          editingIndex -= 1;
        }
      }

      if (selectedIndex !== null) {
        if (selectedIndex === index) {
          selectedIndex = null;
        } else if (selectedIndex > index) {
          selectedIndex -= 1;
        }
      }

      saveContracts();
      render();
    }

    cancelEditButton.addEventListener('click', () => {
      resetFormState();
      render();
    });

    form.addEventListener('submit', event => {
      event.preventDefault();
      const formData = new FormData(form);

      const monthly = Number(formData.get('monthly')) || 0;
      const upfront = Number(formData.get('upfront')) || 0;
      const duration = Number(formData.get('duration')) || 0;
      const bonus = Number(formData.get('bonus')) || 0;
      const connectionFeeAmount = formData.get('connectionFee') ? 40 : 0;

      let device = formData.get('device') || '';
      const link = (formData.get('link') || '').trim();

      if (device === '__new__') {
        const newDevice = newDeviceInput.value.trim();
        if (newDevice) {
          if (!devices.includes(newDevice)) {
            devices.push(newDevice);
            devices.sort((a, b) => a.localeCompare(b, 'de', { sensitivity: 'base' }));
            saveDevices();
          }
          device = newDevice;
          populateDeviceOptions(device);
        } else {
          device = '';
        }
      }

      const newContract = {
        provider: (formData.get('provider') || '').trim(),
        plan: (formData.get('plan') || '').trim(),
        monthly,
        upfront,
        duration,
        bonus,
        data: formData.get('data'),
        flat: formData.get('flat'),
        device,
        link,
        notes: (formData.get('notes') || '').trim(),
        connectionFeeAmount,
      };

      updateContractCalculations(newContract);
      const isEdit = editingIndex !== null;

      if (isEdit) {
        contracts[editingIndex] = { ...contracts[editingIndex], ...newContract };
      } else {
        contracts.push(newContract);
      }

      saveContracts();

      const keepDeviceSelection = isEdit ? '' : newContract.device || '';
      resetFormState(keepDeviceSelection);

      render();
    });

    resetFormState();
    render();
  </script>
</body>
</html>
